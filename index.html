<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Order Sell - ตัดสต็อกสินค้า</title>
  <style>
    :root{
      --brand:#ff3b30; --muted:#f6f7fb; --text:#222; --border:#e6e8ef;
    }
    *{box-sizing:border-box}
    body{font-family:system-ui,Segoe UI,Roboto,TH Sarabun New,sans-serif;background:#fff;margin:0;color:var(--text)}
    .wrap{max-width:920px;margin:24px auto;padding:0 16px}
    .card{background:#fff;border:1px solid var(--border);border-radius:14px;box-shadow:0 2px 12px rgba(0,0,0,.04);margin-bottom:16px;position:relative}
    .head{background:linear-gradient(90deg,#ff3b30,#ff6a59);color:#fff;padding:18px 16px}
    .head h1{font-size:20px;margin:0}
    .body{padding:16px}
    label{display:block;font-weight:600;margin:14px 0 6px}
    input[type="number"],input[type="text"],select{
      width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:10px;outline:none
    }
    input[type="number"]:focus,select:focus,input[type="text"]:focus{border-color:#ffb6b6;box-shadow:0 0 0 4px #ffe9e9}
    .row{display:grid;gap:12px}
    @media(min-width:720px){ .row{grid-template-columns: 1.2fr 1fr}}
    .selected{font-size:13px;color:#ff3b30;margin-top:8px}
    .divider{height:1px;background:var(--border);margin:14px 0}
    button{background:var(--brand);color:#fff;border:none;border-radius:10px;padding:12px 16px;font-size:16px;cursor:pointer}
    button:disabled{opacity:.6;cursor:not-allowed}
    .pill{display:inline-block;background:#ffeef0;color:#ff3b30;border:1px solid #ffd6d6;border-radius:999px;padding:4px 10px;font-size:12px}
    .success{background:#f0fff4;border:1px solid #c7f0d2;color:#146c2e;padding:10px;border-radius:10px}
    .error{background:#fff5f5;border:1px solid #ffd6d6;color:#b42318;padding:10px;border-radius:10px}
    .remove-btn{background:#e74c3c;margin-top:10px}
    .invalid{border-color:#ff8a8a !important;box-shadow:0 0 0 3px rgba(255,0,0,.12) !important}
    .item-title{font-weight:700;margin:6px 0 10px;color:#ff3b30}

    /* autocomplete */
    .ac-wrap{position:relative}
    .ac-input{width:100%}
    .ac-list{position:absolute;left:0;right:0;z-index:1000;max-height:240px;overflow-y:auto;background:#fff;border:1px solid var(--border);border-radius:8px;margin-top:6px;box-shadow:0 4px 12px rgba(0,0,0,.15);display:none}
    .ac-item{padding:8px 12px;cursor:pointer}
    .ac-item:hover,.ac-item[aria-selected="true"]{background:#ffeef0}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="head">
        <h1>Order Sell - ตัดสต็อกสินค้า</h1>
        <div class="pill">ดึงข้อมูลอัตโนมัติจาก Google Sheet</div>
      </div>
      <div class="body">
        <!-- เลือกร้าน -->
        <label>เลือกร้าน</label>
        <select id="shopSelect" disabled required>
          <option value="">— กำลังโหลดร้าน —</option>
        </select>

        <!-- เอกสารอ้างอิง -->
        <label style="margin-top:12px;">เอกสารอ้างอิง</label>
        <input id="docRef" type="text" placeholder="เช่น SO01234" required />

        <div class="divider"></div>

        <div id="items-container"></div>
        <button style="margin-top:8px" onclick="addItem()">+ เพิ่มรายการสินค้า</button>
        <div class="divider"></div>
        <button id="btnSubmit" disabled>บันทึกข้อมูล</button>
        <div id="result" style="margin-top:12px"></div>
      </div>
    </div>
  </div>

<script>
const SPREADSHEET_ID = "12diTyC0GpFlmwcn3yQl8D_cg08LlBPz7pUB43dKFri0";
const ITEM_SHEET = "ListItem";
const SHOP_SHEET = "CompanyName";
const WEBHOOK_URL = "https://primary-production-884f.up.railway.app/webhook-test/OrderSell";
const AC_LIMIT = 1500;
let productList=[], shopList=[];

async function fetchSheet(sheet){
  const url=`https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(sheet)}`;
  const res=await fetch(url); const text=await res.text();
  const jsonStr=text.substring(text.indexOf("{"), text.lastIndexOf("}")+1);
  const data=JSON.parse(jsonStr); return data.table.rows||[];
}
async function loadProducts(){
  const rows=await fetchSheet(ITEM_SHEET);
  return rows.map(r=>{
    const c=r.c||[];
    return {sku:(c[0]?.f??String(c[0]?.v??"")).trim(),name:(c[1]?.f??String(c[1]?.v??"")).trim()};
  }).filter(x=>x.sku&&x.name);
}
async function loadShops(){
  const rows=await fetchSheet(SHOP_SHEET);
  return rows.map(r=>{const c=r.c||[];return (c[0]?.f??String(c[0]?.v??"")).trim();}).filter(s=>s&&s!=="ร้าน"&&s.toLowerCase()!=="shop");
}

function buildItemBlock(){
  const div=document.createElement('div');
  div.className='card';
  div.innerHTML=`
    <div class="body">
      <div class="item-title"></div>
      <label>ค้นหาสินค้า (ชื่อหรือรหัส)</label>
      <div class="ac-wrap">
        <input class="ac-input" type="text" placeholder="พิมพ์ชื่อ หรือ รหัสสินค้า" autocomplete="off"/>
        <div class="ac-list"></div>
      </div>
      <div class="selected selectedInfo" style="display:none"></div>
      <div class="row">
        <div>
          <label>จำนวน</label>
          <input class="qty" type="number" min="1" step="1" placeholder="เช่น 5" required />
        </div>
        <div>
          <label>หมายเหตุ (ถ้ามี)</label>
          <input class="note" type="text" placeholder="เช่น ขายสินค้า, ลดสต็อก" />
        </div>
      </div>
      <button class="remove-btn" onclick="this.closest('.card').remove();renumberItems();checkBtnSubmit()">ลบรายการนี้</button>
    </div>`;
  div.dataset.sku=""; div.dataset.name="";
  return div;
}

function attachAutocomplete(block){
  const input=block.querySelector('.ac-input');
  const list=block.querySelector('.ac-list');
  const selInfo=block.querySelector('.selectedInfo');
  let activeIndex=-1;
  function close(){list.style.display='none';}
  function render(items){
    list.innerHTML=""; if(!items.length){close();return;}
    items.forEach((p,i)=>{
      const el=document.createElement('div');
      el.className='ac-item'; el.textContent=`${p.name} — ${p.sku}`;
      el.addEventListener('mousedown',e=>{
        e.preventDefault();
        input.value=`${p.name} — ${p.sku}`;
        block.dataset.sku=p.sku; block.dataset.name=p.name;
        selInfo.style.display='block'; selInfo.textContent=`เลือกแล้ว: ${p.name} (${p.sku})`;
        close(); checkBtnSubmit();
      });
      list.appendChild(el);
    });
    list.style.display='block';
  }
  input.addEventListener('input',()=>{
    const t=input.value.toLowerCase().trim();
    const out=productList.filter(p=>p.name.toLowerCase().includes(t)||p.sku.toLowerCase().includes(t)).slice(0,AC_LIMIT);
    render(out);
  });
  input.addEventListener('focus',()=>input.dispatchEvent(new Event('input')));
  input.addEventListener('blur',()=>setTimeout(close,150));
}

function addItem(){
  const c=document.getElementById('items-container');
  const b=buildItemBlock(); c.appendChild(b);
  attachAutocomplete(b); renumberItems(); checkBtnSubmit();
}
function renumberItems(){
  document.querySelectorAll('#items-container .item-title').forEach((el,i)=>el.textContent=`รายการที่ ${i+1}`);
}
function validateForm(showErrors=false){
  let ok=true; const errs=[]; const result=document.getElementById('result');
  document.querySelectorAll('.invalid').forEach(el=>el.classList.remove('invalid'));
  const shop=document.getElementById('shopSelect'),doc=document.getElementById('docRef');
  if(!shop.value){ok=false;errs.push('กรุณาเลือกร้าน');if(showErrors)shop.classList.add('invalid');}
  if(!doc.value.trim()){ok=false;errs.push('กรุณากรอกเอกสารอ้างอิง');if(showErrors)doc.classList.add('invalid');}
  const blocks=[...document.querySelectorAll('#items-container .card')];
  if(!blocks.length){ok=false;errs.push('กรุณาเพิ่มสินค้าอย่างน้อย 1 รายการ');}
  else blocks.forEach((b,i)=>{
    if(!b.dataset.sku){ok=false;errs.push(`รายการที่ ${i+1}: กรุณาเลือกสินค้า`);if(showErrors)b.querySelector('.ac-input').classList.add('invalid');}
    const qty=parseInt(b.querySelector('.qty').value||"0",10);
    if(!(qty>=1)){ok=false;errs.push(`รายการที่ ${i+1}: กรอกจำนวน ≥ 1`);if(showErrors)b.querySelector('.qty').classList.add('invalid');}
  });
  if(showErrors&&errs.length)result.innerHTML=`<div class="error">${errs.join("<br>")}</div>`; else if(showErrors)result.innerHTML="";
  return ok;
}
function checkBtnSubmit(){document.getElementById('btnSubmit').disabled=!validateForm(false);}
async function submitPayload(){
  if(!validateForm(true))return;
  const shop=document.getElementById('shopSelect').value,doc=document.getElementById('docRef').value;
  const payloads=[...document.querySelectorAll('#items-container .card')].map(b=>({
    action:"order_sell",shop,doc_ref:doc,sku:b.dataset.sku,name:b.dataset.name,
    qty:-Math.abs(parseInt(b.querySelector('.qty').value||"0",10)),
    note:b.querySelector('.note').value,
    timestamp_iso:new Date().toISOString()
  })).filter(x=>x.sku);
  try{
    const r=await fetch(WEBHOOK_URL,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(payloads)});
    const text=await r.text(); let js={};try{js=JSON.parse(text);}catch{}
    document.getElementById('result').innerHTML=`<div class="success">ส่งสำเร็จ 🎉<br><pre>${JSON.stringify(js||text,null,2)}</pre></div>`;
  }catch(e){document.getElementById('result').innerHTML=`<div class="error">ส่งไม่สำเร็จ: ${e.message}</div>`;}
}

document.getElementById('btnSubmit').addEventListener('click',submitPayload);

(async function init(){
  productList=await loadProducts(); shopList=await loadShops();
  const shopSel=document.getElementById('shopSelect');
  shopSel.innerHTML=`<option value="">— เลือกร้าน —</option>`+shopList.map(s=>`<option>${s}</option>`).join('');
  shopSel.disabled=shopList.length===0; shopSel.addEventListener('change',checkBtnSubmit);
  docRef.addEventListener('input',checkBtnSubmit);
  addItem();
})();
</script>
</body>
</html>
